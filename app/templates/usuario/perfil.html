{% extends "base.html" %}

{% block title %}
{% if session.get('usuario_id') == usuario.id %}
    Mi Perfil - Barbería
{% else %}
    Perfil de {{ usuario.nombre }} {{ usuario.apellido }} - Barbería
{% endif %}
{% endblock %}

{% block head %}
{% if session.get('usuario_id') == usuario.id %}
    <script src="{{ url_for('static', filename='js/perfil.js') }}" defer></script>
{% endif %}
{% endblock %}

{% block content %}

<div class="min-h-screen bg-gray-100 pt-20">
    <div class="max-w-4xl mx-auto px-4 py-8">
        <!-- Header del perfil -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
                <!-- Foto de perfil -->
                <div class="relative">
                    <div id="profile-avatar" class="w-32 h-32 bg-black rounded-full flex items-center justify-center text-white text-4xl font-bold overflow-hidden">
                        {% if perfil and perfil.imagen %}
                            <img src="{{ perfil.imagen }}" alt="Foto de perfil" class="w-full h-full object-cover">
                        {% else %}
                            {{ usuario.nombre[0] }}{{ usuario.apellido[0] }}
                        {% endif %}
                    </div>
                    {% if session.get('usuario_id') == usuario.id %}
                    <button id="change-photo-btn" class="absolute bottom-0 right-0 bg-rose-600 hover:bg-rose-700 text-white p-2 rounded-full shadow-lg transition-colors" aria-label="Cambiar foto de perfil">
                        <i class="fas fa-camera text-sm"></i>
                    </button>
                    {% endif %}
                </div>
                
                <!-- Información básica -->
                <div class="flex-1 text-center md:text-left">
                    <h1 id="profile-name" class="text-3xl font-bold text-gray-800 mb-2">
                        {{ usuario.nombre }} {{ usuario.apellido }}
                    </h1>
                    <p id="profile-email" class="text-gray-600 mb-2">{{ usuario.correo }}</p>
                    <p id="profile-phone" class="text-gray-600 mb-4">
                        <i class="fas fa-phone mr-2"></i><span id="phone-text">{{ usuario.telefono or 'No especificado' }}</span>
                    </p>
                    <p id="profile-description" class="text-gray-700 mb-4">
                        {{ perfil.descripcion if perfil and perfil.descripcion else 'Descripción del perfil aquí...' }}
                    </p>
                    {% if session.get('usuario_id') == usuario.id %}
                    <button id="edit-profile-btn" class="bg-gray-800 hover:bg-gray-700 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-edit mr-2"></i>Editar Perfil
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Redes sociales -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Redes Sociales</h2>
                {% if session.get('usuario_id') == usuario.id %}
                <button id="add-social-btn" class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-plus mr-2"></i>Añadir Red Social
                </button>
                {% endif %}
            </div>
            
            <div id="social-networks" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% if redes %}
                    {% for red in redes %}
                    <div class="bg-gray-50 rounded-lg p-4 flex items-center justify-between hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <div class="w-12 h-12 {{ social_platforms[red.platform].color }} rounded-lg flex items-center justify-center text-white shrink-0">
                                <i class="{{ social_platforms[red.platform].icon }} text-3xl"></i>
                            </div>
                            <div class="min-w-0">
                                <h3 class="font-semibold text-gray-800 truncate">{{ social_platforms[red.platform].name }}</h3>
                                <p class="text-sm text-gray-600 break-all whitespace-normal leading-snug">{{ red.username }}</p>
                            </div>
                        </div>
                        <div class="flex gap-2 shrink-0">
                            <button onclick="openSocialLink('{{ red.platform }}', '{{ red.username | safe }}')" class="text-blue-600 hover:text-blue-800 p-2" aria-label="Abrir enlace de {{ social_platforms[red.platform].name }}">
                                <i class="fas fa-external-link-alt"></i>
                            </button>
                            {% if session.get('usuario_id') == usuario.id %}
                            <button onclick="removeSocialNetwork('{{ red.id | safe }}')" class="text-red-600 hover:text-red-800 p-2" aria-label="Eliminar red social">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-span-full text-center py-8 text-gray-500">
                        <i class="fas fa-share-alt text-4xl mb-4"></i>
                        <p>No hay redes sociales agregadas</p>
                        {% if session.get('usuario_id') == usuario.id %}
                        <p class="text-sm">Haz clic en "Añadir Red Social" para comenzar</p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Seguridad -->
        {% if session.get('usuario_id') == usuario.id %}
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Seguridad</h2>

            <!-- Cambiar contraseña -->
            <div class="border-b border-gray-200 pb-4 mb-4">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Cambiar Contraseña</h3>
                <p class="text-gray-600 text-sm mb-4">Actualiza tu contraseña para mantener tu cuenta segura.</p>
                <button id="change-password-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-key mr-2"></i>Cambiar Contraseña
                </button>
            </div>

            <!-- Eliminar cuenta -->
            <div class="">
                <h3 class="text-lg font-semibold text-red-700 mb-2">Eliminar Cuenta</h3>
                <div class="border border-red-200 rounded-lg p-4 bg-red-50">
                    <p class="text-red-600 text-sm mb-4">Esta acción no se puede deshacer. Se eliminarán permanentemente todos tus datos.</p>
                    <button id="delete-account-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-trash mr-2"></i>Eliminar Cuenta
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modales (solo para el usuario logueado) -->
{% if session.get('usuario_id') == usuario.id %}
<!-- Modal para editar perfil -->
<div id="edit-profile-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-md w-full p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Editar Perfil</h3>
            <button id="close-edit-modal" class="text-gray-500 hover:text-gray-700" aria-label="Cerrar">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="edit-profile-form">
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Nombre</label>
                <input type="text" id="edit-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-rose-500" value="{{ usuario.nombre }}">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Apellido</label>
                <input type="text" id="edit-lastname" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-rose-500" value="{{ usuario.apellido }}">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Teléfono</label>
                <input type="tel" id="edit-phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-rose-500" placeholder="+1234567890" value="{{ usuario.telefono or '' }}">
            </div>
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2">Descripción</label>
                <textarea id="edit-description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-rose-500" placeholder="Cuéntanos sobre ti...">{{ perfil.descripcion if perfil else '' }}</textarea>
            </div>
            <div class="flex gap-3">
                <button type="button" id="cancel-edit" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button type="submit" class="flex-1 bg-rose-600 hover:bg-rose-700 text-white py-2 px-4 rounded-lg transition-colors">
                    Guardar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para añadir red social -->
<div id="add-social-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-md w-full p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Añadir Red Social</h3>
            <button id="close-social-modal" class="text-gray-500 hover:text-gray-700" aria-label="Cerrar">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="add-social-form">
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Red Social</label>
                <div class="relative">
                    <div id="social-dropdown" class="w-full px-3 py-2 border border-gray-300 rounded-lg cursor-pointer bg-white flex items-center justify-between">
                        <span id="selected-social" class="text-gray-500">Seleccionar red social</span>
                        <i class="fas fa-chevron-down text-gray-400"></i>
                    </div>
                    <div id="social-options" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg mt-1 shadow-lg z-10 hidden max-h-60 overflow-y-auto">
                        <!-- Las opciones se cargarán dinámicamente -->
                    </div>
                </div>
                <input type="hidden" id="social-platform" value="">
            </div>
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2">Usuario/Enlace</label>
                <input type="text" id="social-username" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-rose-500" placeholder="@usuario o enlace completo">
            </div>
            <div class="flex gap-3">
                <button type="button" id="cancel-social" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button type="submit" class="flex-1 bg-rose-600 hover:bg-rose-700 text-white py-2 px-4 rounded-lg transition-colors">
                    Añadir
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para cambiar foto -->
<div id="change-photo-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-md w-full p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Cambiar Foto de Perfil</h3>
            <button id="close-photo-modal" class="text-gray-500 hover:text-gray-700" aria-label="Cerrar">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="text-center">
            <input type="file" id="photo-input" accept="image/*" class="hidden">
            <button id="upload-photo-btn" class="bg-rose-600 hover:bg-rose-700 text-white px-6 py-3 rounded-lg mb-4 transition-colors">
                <i class="fas fa-upload mr-2"></i>Subir Imagen
            </button>
            <!-- Botón para eliminar foto cuando hay una personalizada -->
            <div id="remove-photo-section" class="{% if not perfil or not perfil.imagen %}hidden{% endif %}">
                <button id="remove-photo-btn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg mb-4 transition-colors">
                    <i class="fas fa-trash mr-2"></i>Eliminar Foto
                </button>
            </div>
            <p class="text-gray-600 text-sm mb-4">O mantener imagen con iniciales</p>
            <button id="keep-initials-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg transition-colors">
                Mantener Iniciales
            </button>
        </div>
    </div>
</div>

<!-- Modal: validar contraseña para eliminar cuenta -->
<div id="delete-account-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-sm w-full p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold">Confirmar identidad</h3>
      <button id="close-delete-modal" class="text-gray-500 hover:text-gray-700" aria-label="Cerrar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="delete-account-form" class="space-y-4">
      <div>
        <label for="delete-password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
        <div class="relative">
          <input
            type="password"
            id="delete-password"
            class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:border-rose-500 bg-white"
            placeholder="Escribe tu contraseña"
            required
          />
          <button type="button" class="absolute inset-y-0 right-0 pr-3 text-gray-500 hover:text-gray-700" data-password-toggle aria-controls="delete-password" aria-label="Mostrar u ocultar">
            <i class="far fa-eye"></i>
          </button>
        </div>
      </div>
      <div class="flex items-center justify-between gap-3">
        <button type="button" id="cancel-delete" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg transition-colors">
          Cancelar
        </button>
        <button type="submit" class="flex-1 bg-rose-600 hover:bg-rose-700 text-white py-2 px-4 rounded-lg transition-colors">
          Continuar
        </button>
      </div>
      <div class="text-right">
        <a href="{{ url_for('auth.reset_password') }}" class="text-sm text-rose-600 hover:text-rose-500 hover:underline">¿Olvidaste tu contraseña?</a>
      </div>
    </form>
  </div>
</div>

<!-- Modal: confirmación final de eliminación -->
<div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-sm w-full p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold text-red-600">¿Eliminar cuenta definitivamente?</h3>
      <button id="close-confirm-modal" class="text-gray-500 hover:text-gray-700" aria-label="Cerrar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <p class="text-gray-700 mb-4">Esta acción eliminará todos tus datos y no se puede deshacer.</p>
    <div class="flex gap-3">
      <button id="cancel-confirm-delete" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg transition-colors">
        Cancelar
      </button>
      <button id="confirm-delete-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg transition-colors">
        Eliminar definitivamente
      </button>
    </div>
  </div>
</div>

<!-- Modal: cambiar contraseña -->
<div id="change-password-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-md w-full p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold">Cambiar contraseña</h3>
      <button id="close-change-password" class="text-gray-500 hover:text-gray-700" aria-label="Cerrar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="change-password-form" class="space-y-4">
      <div>
        <label for="current-password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña actual</label>
        <div class="relative">
          <input type="password" id="current-password" class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:border-rose-500 bg-white" required />
          <button type="button" class="absolute inset-y-0 right-0 pr-3 text-gray-500 hover:text-gray-700" data-password-toggle aria-controls="current-password" aria-label="Mostrar u ocultar">
            <i class="far fa-eye"></i>
          </button>
        </div>
      </div>
      <div>
        <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">Nueva contraseña</label>
        <div class="relative">
          <input type="password" id="new-password" class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:border-rose-500 bg-white" required />
          <button type="button" class="absolute inset-y-0 right-0 pr-3 text-gray-500 hover:text-gray-700" data-password-toggle aria-controls="new-password" aria-label="Mostrar u ocultar">
            <i class="far fa-eye"></i>
          </button>
        </div>
      </div>
      <div>
        <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">Confirmar contraseña</label>
        <div class="relative">
          <input type="password" id="confirm-password" class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:border-rose-500 bg-white" required />
          <button type="button" class="absolute inset-y-0 right-0 pr-3 text-gray-500 hover:text-gray-700" data-password-toggle aria-controls="confirm-password" aria-label="Mostrar u ocultar">
            <i class="far fa-eye"></i>
          </button>
        </div>
      </div>
      <div class="flex items-center justify-between gap-3">
        <button type="button" id="cancel-change-password" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg transition-colors">
          Cancelar
        </button>
        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors">
          Guardar cambios
        </button>
      </div>
      <div class="text-right">
        <a href="{{ url_for('auth.reset_password') }}" class="text-sm text-rose-600 hover:text-rose-500 hover:underline">¿Olvidaste tu contraseña?</a>
      </div>
    </form>
  </div>
</div>
{% endif %}

{% endblock %}
{% extends 'base.html' %} {% block title %}Notificaciones{% endblock %} {% block
content %}
<section class="pt-24 pb-12 container mx-auto px-4">
  <h1 class="text-2xl font-bold mb-6">Notificaciones</h1>

  <div class="flex items-center justify-between mb-4">
    <p class="text-gray-600" id="notif-summary">Cargando...</p>
    <div class="flex items-center gap-2">
      <button
        id="mark-all"
        class="px-3 py-1.5 text-sm bg-gray-800 text-white rounded hover:bg-gray-700"
      >
        Marcar todas como le√≠das
      </button>
    </div>
  </div>

  <div id="notif-list" class="space-y-3">
    <div class="p-4 bg-white rounded border border-gray-200">
      Cargando notificaciones...
    </div>
  </div>
</section>

<script>
  const NAV_BADGE_IDS = [
    "notif-count",
    "notif-count-menu",
    "notif-count-avatar",
    "notif-count-mobile",
    "notif-count-hamburger"
  ];
  let notificationsRefreshScheduled = false;
  let lastSnapshotSignature = null;

  function snapshotSignature(snapshot) {
    if (!snapshot || typeof snapshot !== "object") return null;
    const previous = window.__lastNotificationSnapshot || {};
    const countValue = Number(snapshot.count);
    const safeCount = Number.isFinite(countValue) ? Math.max(Math.trunc(countValue), 0) : 0;
    const latestSource = Object.prototype.hasOwnProperty.call(snapshot, "latest_id")
      ? snapshot.latest_id
      : previous.latest_id;
    const latestNumeric = Number(latestSource);
    const safeLatestId = Number.isFinite(latestNumeric) ? Math.max(Math.trunc(latestNumeric), 0) : 0;
    const lastActivitySource = Object.prototype.hasOwnProperty.call(snapshot, "last_activity")
      ? snapshot.last_activity
      : previous.last_activity;
    const lastActivity = lastActivitySource || "";
    return `${safeCount}|${safeLatestId}|${lastActivity}`;
  }

  function publishSnapshot(snapshot) {
    if (!snapshot || typeof snapshot !== "object") return;
    try {
      document.dispatchEvent(new CustomEvent("notifications:update", { detail: snapshot }));
    } catch (error) {
      // Silenciar fallos del bridge de eventos
    }
  }

  const initialSnapshot = window.__lastNotificationSnapshot || null;
  if (initialSnapshot) {
    lastSnapshotSignature = snapshotSignature(initialSnapshot);
  }

  function scheduleRefreshFromSnapshot(snapshot) {
    const signature = snapshotSignature(snapshot);
    if (signature && signature === lastSnapshotSignature) {
      return;
    }
    if (notificationsRefreshScheduled) {
      return;
    }
    notificationsRefreshScheduled = true;
    setTimeout(() => {
      notificationsRefreshScheduled = false;
      fetchNotifs();
    }, 150);
  }

  document.addEventListener("notifications:update", (event) => {
    scheduleRefreshFromSnapshot(event.detail || null);
  });

  function estadoPill(estado) {
    if (!estado) return "";
    const map = {
      confirmado: "bg-blue-100 text-blue-700 border-blue-200",
      cancelado: "bg-rose-100 text-rose-700 border-rose-200",
      completado: "bg-green-100 text-green-700 border-green-200",
      reservada: "bg-amber-100 text-amber-700 border-amber-200"
    };
    const cls = map[estado] || "bg-gray-100 text-gray-700 border-gray-200";
    const label =
      estado === "confirmado"
        ? "confirmada"
        : estado === "cancelado"
        ? "cancelada"
        : estado === "completado"
        ? "completada"
        : estado;
    return `<span class="inline-block text-xs font-semibold px-2 py-0.5 rounded border ${cls}">${label}</span>`;
  }

  function formatearHora(hora24) {
    if (!hora24) return "";
    const partes = hora24.split(":");
    if (partes.length < 2) return hora24;
    const horas = parseInt(partes[0], 10);
    const minutos = parseInt(partes[1], 10);
    if (Number.isNaN(horas) || Number.isNaN(minutos)) return hora24;
    let sufijo = "AM";
    let display = horas % 12;
    if (display === 0) display = 12;
    if (horas >= 12) sufijo = "PM";
    return `${display.toString().padStart(2, "0")}:${minutos
      .toString()
      .padStart(2, "0")} ${sufijo}`;
  }

  function updateNavCounters(count) {
    const numericValue = Number(count);
    const safeCount = Number.isFinite(numericValue) ? Math.max(Math.trunc(numericValue), 0) : 0;

    if (typeof updateNotifBadges === "function") {
      updateNotifBadges(safeCount);
    } else {
      const displayValue = safeCount > 99 ? "99+" : String(safeCount);
      NAV_BADGE_IDS.map((id) => document.getElementById(id))
        .filter(Boolean)
        .forEach((el) => {
          el.textContent = displayValue;
          el.classList.toggle("hidden", safeCount === 0);
        });
    }

    if (window.__lastNotificationSnapshot) {
      window.__lastNotificationSnapshot = {
        ...window.__lastNotificationSnapshot,
        count: safeCount
      };
    } else {
      window.__lastNotificationSnapshot = {
        count: safeCount,
        latest_id: 0,
        last_activity: null,
        latest_created: null
      };
    }
  }

  async function fetchNotifs() {
    const list = document.getElementById("notif-list");
    const summary = document.getElementById("notif-summary");
    try {
      const res = await fetch("/api/notificaciones?limit=50", { credentials: "same-origin" });
      if (!res.ok) throw new Error("No se pudo obtener notificaciones");
      const data = await res.json();
      if (!Array.isArray(data)) throw new Error("Respuesta invalida");

      const unreadCount = data.filter((n) => !n.leida).length;
      summary.textContent = `${unreadCount} sin leer, ${data.length} totales`;
      updateNavCounters(unreadCount);

      if (data.length === 0) {
        list.innerHTML =
          '<div class="p-4 bg-gray-50 text-gray-600 rounded">No tienes notificaciones.</div>';
        const snapshot = {
          count: unreadCount,
          latest_id: (window.__lastNotificationSnapshot && window.__lastNotificationSnapshot.latest_id) || 0,
          last_activity: (window.__lastNotificationSnapshot && window.__lastNotificationSnapshot.last_activity) || null,
          latest_created: (window.__lastNotificationSnapshot && window.__lastNotificationSnapshot.latest_created) || null
        };
        window.__lastNotificationSnapshot = snapshot;
        lastSnapshotSignature = snapshotSignature(snapshot);
        publishSnapshot(snapshot);
        return;
      }

      list.innerHTML = data
        .map((n) => {
          const isCita = n.tipo === "cita";
          const estado = n.data && n.data.estado;
          let bodyHtml = "";

          if (isCita && estado) {
            const dataInfo = n.data || {};
            const citaId = dataInfo.client_sequence ?? dataInfo.cita_id ?? "";
            const fecha = dataInfo.fecha || "";
            const hora = dataInfo.hora || "";
            const horaFormateada = formatearHora(hora);
            const citaLabel = citaId ? `Tu cita #${citaId}` : "Tu cita";
            const fechaHoraTexto =
              fecha && horaFormateada
                ? `Dia ${fecha} a las ${horaFormateada}`
                : fecha
                ? `Dia ${fecha}`
                : horaFormateada
                ? `A las ${horaFormateada}`
                : "";
            const detalleExtra = fechaHoraTexto
              ? ` <span class="ml-1 text-gray-500">${fechaHoraTexto}</span>`
              : "";
            bodyHtml = `<p class="text-gray-700 mt-1">${citaLabel} ha sido ${estadoPill(
              estado
            )}.${detalleExtra}</p>`;
          } else if (n.mensaje) {
            bodyHtml = `<p class="text-gray-600 mt-1">${n.mensaje}</p>`;
          }

          const linkHtml =
            n.data && n.data.url
              ? `<a href="${n.data.url}" class="mt-2 inline-block text-rose-600 hover:text-rose-700 text-sm">Abrir</a>`
              : "";

          return `
      <article class="p-4 rounded border ${
        n.leida ? "bg-white border-gray-200" : "bg-rose-50 border-rose-200"
      }">
        <div class="flex items-start justify-between">
          <div>
            <h3 class="font-semibold ${
              n.leida ? "text-gray-800" : "text-gray-900"
            }">${n.titulo || "Notificacion"}</h3>
            ${bodyHtml}
            ${linkHtml}
          </div>
          <div class="ml-4">
            ${
              n.leida
                ? ""
                : `<button data-id="${n.id}" class="mark-one text-xs px-2 py-1 bg-gray-800 text-white rounded">Marcar leida</button>`
            }
          </div>
        </div>
      </article>`;
        })
        .join("");

      document.querySelectorAll(".mark-one").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          try {
            await fetch(`/api/notificaciones/${id}/leida`, { method: "POST", credentials: "same-origin" });
          } catch (error) {
            console.error("Error al marcar notificacion", error);
          }
          fetchNotifs();
        });
      });

      const latestNotification = data[0] || null;
      const previousSnapshot = window.__lastNotificationSnapshot || {};
      const snapshot = {
        count: unreadCount,
        latest_id: (latestNotification && latestNotification.id) ?? previousSnapshot.latest_id ?? 0,
        last_activity:
          (latestNotification && (latestNotification.leida_en || latestNotification.creada_en)) ??
          previousSnapshot.last_activity ??
          null,
        latest_created: (latestNotification && latestNotification.creada_en) ?? previousSnapshot.latest_created ?? null
      };
      window.__lastNotificationSnapshot = snapshot;
      lastSnapshotSignature = snapshotSignature(snapshot);
      publishSnapshot(snapshot);
    } catch (error) {
      console.error("Error al cargar notificaciones", error);
      summary.textContent = "No se pudieron cargar las notificaciones";
      list.innerHTML =
        '<div class="p-4 bg-red-50 text-red-600 rounded">Error al cargar notificaciones.</div>';
    }
  }

  async function markAll() {
    try {
      await fetch("/api/notificaciones/leidas_todas", { method: "POST", credentials: "same-origin" });
    } catch (error) {
      console.error("Error al marcar todas las notificaciones", error);
    }
    fetchNotifs();
  }

  document.getElementById("mark-all").addEventListener("click", markAll);
  fetchNotifs();

</script>
{% endblock %}

